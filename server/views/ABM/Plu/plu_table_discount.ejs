<!DOCTYPE html>
<html>

<%- include('../../templates/head', {datahead: {titulo: 'Descuentos', css: '/css/ABM/PLUs/plu_table_discount.css' }}) %>

    <body>
        <div class="table">
            <div class="container-table">
                <table id='myTable'>
                    <thead>
                        <tr>
                            <th>
                                <input class="header-table" type="text" value="HASTA" readonly>
                            </th>
                            <th>
                                <input class="header-table" type="text" value="PRECIO" readonly>
                            </th>
                            <th class="th-icon">
                                <input class="header-icon" type="text" value="" readonly>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <% if (data !=='' && data !==null && data !==undefined) { %>
                            <% for (var i=0; i < data.length; i++ ) { %>
                                <tr>
                                    <form method="POST" action="/api/menu/abm/plu/formEditGral/updateDiscount">
                                        <input style="display: none" type="text" name="discountid" value="<%= data[i].id %>"/>
                                        <td>
                                            <input class="inputPrice" type="number" name="hasta" id="hasta'<%=i%>'" min="0" pattern="^[0-9]+"
                                                value="<%= data[i].hasta %>" 
                                                onclick="this.value=''" onchange="checkHasta(this.id, this.value, this.form)" required/>
                                        </td>
                                        <td>
                                            <input class="inputPrice" type="number" name="precio" min="0" pattern="^[0-9]+"
                                                value="<%- parseInt(data[i].precio).toFixed(2) %>"
                                                onclick="this.value=''" onchange="this.form.submit()" required/>
                                        </td>
                                        <td class="td-icon">
                                            <input type='button' class="btn-td-icon-delete" onclick="formDelete(this.form)">
                                        </td>                                        
                                    </form>
                                </tr>
                            <% } %>
                        <% } else { %>
                            <tr>
                                <td colspan="3">No hay registros!</td>
                            </tr>
                        <% } %>
                        <tr>
                            <form method="POST" id="formInsert" action="/api/menu/abm/plu/formEditGral/createDiscount">
                                <td>
                                    <input class="inputNewPrice" type="number" name="hasta" id="hastaNew" min="0" pattern="^[0-9]+" value="" onchange="checkHasta(this.id, this.value, this.form)" required />
                                </td>
                                <td>
                                    <input class="inputNewPrice" type="number" name="price" min="0" pattern="^[0-9]+" required />
                                </td>
                                <td class="td-icon">
                                    <input type='submit' value='' class="btn-td-icon-create" />
                                </td>                                
                            </form>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <script>
            //console.log(<%#-JSON.stringify(data)%>);            

            function checkHasta(id, value, form) {
                let repeat = false;                
                <% for (var i=0; i < data.length; i++ ) { %>
                        if(<%=data[i].hasta%> == value){
                            repeat = true;
                            alert('El valor ingresado ya existe!');
                            document.getElementById(id).value = '';
                        } 
                <% } %> 
                if (repeat == false && value != 0) {
                    let oForm = form;
                    if (oForm) {
                        oForm.submit();
                    }
                } else {
                    document.getElementById(id).setAttribute('invalid', true);
                }    
            }


            function formDelete(formId) {
                let oForm = formId;
                oForm.setAttribute("action", '/api/menu/abm/plu/formEditGral/deleteDiscount');
                if (oForm) {
                    oForm.submit();
                }
            }

        </script>
    </body>

</html>